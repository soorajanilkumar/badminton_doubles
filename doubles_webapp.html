<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Doubles Game Webapp</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 30px; }
        table { border-collapse: collapse; margin-top: 20px; }
        th, td { border: 1px solid #ccc; padding: 8px; }
        th { background: #eee; }
        .team-select { margin-top: 20px; }
        .main-flex { display: flex; gap: 40px; align-items: flex-start; }
        #results { min-width: 420px; }
        #games { min-width: 350px; }
    </style>
</head>
<body>
    <h2>Enter Player Names and Skill Levels (1-10)</h2>
    <div style="margin-bottom:18px;">
        <label>
            Number of Games:
            <input type="number" id="numGames" value="5" min="1" max="20" style="width:60px;">
        </label>
        &nbsp;&nbsp;
        <label>
            Courts per Game:
            <input type="number" id="numCourts" value="2" min="1" max="8" style="width:60px;">
        </label>
    </div>
    <form id="playerForm">
        <table>
            <tr><th>Name</th><th>Skill Level</th></tr>
            <!-- 8 rows for players -->
            <tr><td><input name="name0" required></td><td><input name="skill0" type="number" min="1" max="10" required></td></tr>
            <tr><td><input name="name1" required></td><td><input name="skill1" type="number" min="1" max="10" required></td></tr>
            <tr><td><input name="name2" required></td><td><input name="skill2" type="number" min="1" max="10" required></td></tr>
            <tr><td><input name="name3" required></td><td><input name="skill3" type="number" min="1" max="10" required></td></tr>
            <tr><td><input name="name4" required></td><td><input name="skill4" type="number" min="1" max="10" required></td></tr>
            <tr><td><input name="name5" required></td><td><input name="skill5" type="number" min="1" max="10" required></td></tr>
            <tr><td><input name="name6" required></td><td><input name="skill6" type="number" min="1" max="10" required></td></tr>
            <tr><td><input name="name7" required></td><td><input name="skill7" type="number" min="1" max="10" required></td></tr>
        </table>
        <button type="submit">Generate Doubles</button>
    </form>

    <div class="main-flex">
        <div id="results"></div>
        <div>
            <button id="printGamesBtn" style="margin-bottom:20px; display:none;">Print Games</button>
            <div id="games"></div>
        </div>
    </div>
    <div id="courtSelect"></div>

    <script>
        function getCombinations(arr) {
            let combos = [];
            for (let i = 0; i < arr.length; i++) {
                for (let j = i + 1; j < arr.length; j++) {
                    combos.push([arr[i], arr[j]]);
                }
            }
            return combos;
        }

        let usedTeams = new Set();
        let gamesByRound = [];
        let pairSkillsGlobal = [];
        let selectedCourt = null; // {roundIdx, courtIdx}

        function renderPairs(pairSkills) {
            let html = '<h3>Unique Doubles (Sorted by Skill)</h3>';
            if (selectedCourt !== null) {
                html += `<div class="team-select" style="margin-bottom:10px;"><button id="assignGameBtn">Assign 2vs2 to Selected Court</button></div>`;
            }
            html += '<table><tr><th>Pair</th><th>Combined Skill</th><th>Select</th></tr>';

            // If a court is selected, get already assigned players in the same round
            let assignedPlayers = new Set();
            if (selectedCourt !== null) {
                const roundGames = gamesByRound[selectedCourt.roundIdx];
                roundGames.forEach((game, idx) => {
                    if (game && idx !== selectedCourt.courtIdx) {
                        assignedPlayers.add(game.team1[0]);
                        assignedPlayers.add(game.team1[1]);
                        assignedPlayers.add(game.team2[0]);
                        assignedPlayers.add(game.team2[1]);
                    }
                });
            }

            pairSkills.forEach((p, idx) => {
                const teamKey = p.pair.slice().sort().join(',');
                const color = usedTeams.has(teamKey) ? 'red' : 'green';
                // Only enable selection if a court is selected, team is unused, and no overlap with assignedPlayers
                let overlap = false;
                if (selectedCourt !== null) {
                    overlap = p.pair.some(player => assignedPlayers.has(player));
                }
                const disabled = usedTeams.has(teamKey) || selectedCourt === null || overlap ? 'disabled' : '';
                html += `<tr>
                    <td style="color:${color};font-weight:bold">${p.pair[0]} & ${p.pair[1]}</td>
                    <td>${p.skill}</td>
                    <td><input type="checkbox" class="pair-select" value="${idx}" ${disabled}></td>
                </tr>`;
            });
            html += '</table>';
            html += `<div>Total pairs: ${pairSkills.length}</div>`;
            document.getElementById('results').innerHTML = html;
        }

        function renderGames() {
            let html = '';
            gamesByRound.forEach((roundGames, roundIdx) => {
                html += `<div style="border:2px solid #333; margin:15px 0; padding:10px; border-radius:8px;">
                    <h3>Game ${roundIdx + 1}</h3>
                    <div style="display:flex; gap:30px;">`;
                for (let courtIdx = 0; courtIdx < roundGames.length; courtIdx++) {
                    const game = roundGames[courtIdx];
                    const isSelected = selectedCourt && selectedCourt.roundIdx === roundIdx && selectedCourt.courtIdx === courtIdx;
                    if (game) {
                        html += `<div style="background:${isSelected ? '#e0ffe0' : 'none'};padding:5px;">
                            <b>Court ${courtIdx + 1}:</b><br>
                            <span style="color:red">${game.team1[0]} & ${game.team1[1]}</span> (Skill: ${game.skill1})<br>
                            <span style="color:red">${game.team2[0]} & ${game.team2[1]}</span> (Skill: ${game.skill2})<br>
                            <button class="delete-game-btn" data-round="${roundIdx}" data-court="${courtIdx}">Delete</button>
                        </div>`;
                    } else {
                        html += `<div style="background:${isSelected ? '#e0ffe0' : 'none'};padding:5px;">
                            <b>Court ${courtIdx + 1}:</b><br>
                            <span style="color:gray">[Empty]</span><br>
                            <button class="select-court-btn" data-round="${roundIdx}" data-court="${courtIdx}">Select</button>
                        </div>`;
                    }
                }
                html += `</div></div>`;
            });
            document.getElementById('games').innerHTML = html;
        }

        document.getElementById('playerForm').onsubmit = function(e) {
            e.preventDefault();
            const numGames = parseInt(document.getElementById('numGames').value, 10);
            const numCourts = parseInt(document.getElementById('numCourts').value, 10);
            const names = [];
            const skills = [];
            for (let i = 0; i < 8; i++) {
                names.push(this['name'+i].value.trim());
                skills.push(parseInt(this['skill'+i].value, 10));
            }
            // Build player objects
            const players = names.map((name, idx) => ({ name, skill: skills[idx] }));

            // Generate all unique doubles
            const pairs = getCombinations(players);
            const pairSkills = pairs.map(pair => ({
                pair: [pair[0].name, pair[1].name],
                skill: pair[0].skill + pair[1].skill
            }));
            pairSkills.sort((a, b) => b.skill - a.skill);

            pairSkillsGlobal = pairSkills;
            usedTeams = new Set();
            selectedCourt = null;
            // Pre-generate games with user-defined courts
            gamesByRound = Array.from({length: numGames}, () => Array(numCourts).fill(null));
            renderGames();
            renderPairs(pairSkills);
            document.getElementById('printGamesBtn').style.display = 'inline-block';
        };

        document.addEventListener('click', function(e) {
            // Select a court
            if (e.target && e.target.classList.contains('select-court-btn')) {
                selectedCourt = {
                    roundIdx: parseInt(e.target.getAttribute('data-round')),
                    courtIdx: parseInt(e.target.getAttribute('data-court'))
                };
                renderGames();
                renderPairs(pairSkillsGlobal);
            }

            // Assign a game to selected court
            if (e.target && e.target.id === 'assignGameBtn') {
                const checked = Array.from(document.querySelectorAll('.pair-select:checked')).map(cb => parseInt(cb.value));
                if (checked.length !== 2) {
                    alert('Please select exactly 2 pairs for a 2vs2 game.');
                    return;
                }
                const team1 = pairSkillsGlobal[checked[0]].pair;
                const team2 = pairSkillsGlobal[checked[1]].pair;
                const allPlayers = team1.concat(team2);
                const uniquePlayers = new Set(allPlayers);
                if (uniquePlayers.size < 4) {
                    alert('Teams cannot have overlapping players!');
                    return;
                }
                // Mark teams as used
                usedTeams.add(team1.slice().sort().join(','));
                usedTeams.add(team2.slice().sort().join(','));

                // Prepare game data
                const gameData = {
                    team1: team1,
                    team2: team2,
                    skill1: pairSkillsGlobal[checked[0]].skill,
                    skill2: pairSkillsGlobal[checked[1]].skill
                };

                // Assign to selected court
                if (selectedCourt) {
                    gamesByRound[selectedCourt.roundIdx][selectedCourt.courtIdx] = gameData;
                    selectedCourt = null;
                    renderGames();
                    renderPairs(pairSkillsGlobal);
                }
            }

            // Handle game deletion
            if (e.target && e.target.classList.contains('delete-game-btn')) {
                const roundIdx = parseInt(e.target.getAttribute('data-round'));
                const courtIdx = parseInt(e.target.getAttribute('data-court'));
                const game = gamesByRound[roundIdx][courtIdx];
                if (game) {
                    // Unmark teams as used
                    usedTeams.delete(game.team1.slice().sort().join(','));
                    usedTeams.delete(game.team2.slice().sort().join(','));
                    // Remove game
                    gamesByRound[roundIdx][courtIdx] = null;
                    selectedCourt = null;
                    renderGames();
                    renderPairs(pairSkillsGlobal);
                }
            }
        });

        document.getElementById('printGamesBtn').onclick = function() {
            let html = `
            <html>
            <head>
                <title>Games Print View</title>
                <style>
                    body { font-family: Arial, sans-serif; margin: 30px; }
                    table { border-collapse: collapse; margin-top: 20px; }
                    th, td { border: 1px solid #ccc; padding: 8px; }
                    th { background: #eee; }
                </style>
            </head>
            <body>
                <h2>Games Schedule</h2>
            `;

            gamesByRound.forEach((roundGames, roundIdx) => {
                html += `<h3>Game ${roundIdx + 1}</h3>
                <table>
                    <tr>
                        <th>Court</th>
                        <th>Team 1</th>
                        <th>Team 2</th>
                    </tr>`;
                roundGames.forEach((game, courtIdx) => {
                    if (game) {
                        html += `<tr>
                            <td>${courtIdx + 1}</td>
                            <td>${game.team1[0]} & ${game.team1[1]}</td>
                            <td>${game.team2[0]} & ${game.team2[1]}</td>
                        </tr>`;
                    } else {
                        html += `<tr>
                            <td>${courtIdx + 1}</td>
                            <td colspan="2" style="color:gray">[Empty]</td>
                        </tr>`;
                    }
                });
                html += `</table>`;
            });

            html += `</body></html>`;
            const printWindow = window.open('', '_blank');
            printWindow.document.write(html);
            printWindow.document.close();
        };
    </script>
</body>
</html>
