<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Doubles Game Webapp</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 30px; }
        table { border-collapse: collapse; margin-top: 20px; }
        th, td { border: 1px solid #ccc; padding: 8px; }
        th { background: #eee; }
        .team-select { margin-top: 20px; }
        .main-flex { display: flex; gap: 40px; align-items: flex-start; }
        #results { min-width: 420px; }
        #games { min-width: 350px; }
        /* Dark theme styles */
        body.dark {
            background: #181818;
            color: #e0e0e0;
        }
        body.dark table, body.dark th, body.dark td {
            border-color: #444;
        }
        body.dark th {
            background: #222;
            color: #e0e0e0;
        }
        body.dark td {
            background: #222;
            color: #e0e0e0;
        }
        body.dark input, body.dark button {
            background: #222;
            color: #e0e0e0;
            border: 1px solid #444;
        }
        body.dark .team-select button, body.dark #printGamesBtn {
            background: #333;
            color: #e0e0e0;
            border: 1px solid #555;
        }
        body.dark .main-flex > div {
            background: #222;
        }
    </style>
</head>
<body>
    <div style="position: absolute; top: 20px; right: 30px; z-index: 10;">
        <button id="themeToggleBtn">üåô Dark Theme</button>
    </div>
    <h2>Enter Player Names and Skill Levels (1-10)</h2>
    <div style="margin-bottom:18px;">
        <label>
            Number of Games:
            <input type="number" id="numGames" value="5" min="1" max="20" style="width:60px;">
        </label>
        &nbsp;&nbsp;
        <label>
            Courts per Game:
            <input type="number" id="numCourts" value="2" min="1" max="8" style="width:60px;">
        </label>
    </div>
    <form id="playerForm">
        <table>
            <tr><th>Name</th><th>Skill Level</th></tr>
            <!-- 8 rows for players -->
            <tr><td><input name="name0" required></td><td><input name="skill0" type="number" min="1" max="10" required></td></tr>
            <tr><td><input name="name1" required></td><td><input name="skill1" type="number" min="1" max="10" required></td></tr>
            <tr><td><input name="name2" required></td><td><input name="skill2" type="number" min="1" max="10" required></td></tr>
            <tr><td><input name="name3" required></td><td><input name="skill3" type="number" min="1" max="10" required></td></tr>
            <tr><td><input name="name4" required></td><td><input name="skill4" type="number" min="1" max="10" required></td></tr>
            <tr><td><input name="name5" required></td><td><input name="skill5" type="number" min="1" max="10" required></td></tr>
            <tr><td><input name="name6" required></td><td><input name="skill6" type="number" min="1" max="10" required></td></tr>
            <tr><td><input name="name7" required></td><td><input name="skill7" type="number" min="1" max="10" required></td></tr>
        </table>
        <div style="height:12px;"></div>
        <button type="submit">Generate Teams</button>
    </form>

    <div class="main-flex">
        <div id="results"></div>
        <div>
            <button id="printGamesBtn" style="margin-bottom:20px; display:none;">Print Games</button>
            <div id="games"></div>
        </div>
    </div>
    <div id="courtSelect"></div>

    <script>
        function getCombinations(arr) {
            let combos = [];
            for (let i = 0; i < arr.length; i++) {
                for (let j = i + 1; j < arr.length; j++) {
                    combos.push([arr[i], arr[j]]);
                }
            }
            return combos;
        }

        let usedTeams = new Set();
        let gamesByRound = [];
        let pairSkillsGlobal = [];
        let selectedCourt = null; // {roundIdx, courtIdx}
        let selectedTeamCol = null; // "team1" or "team2"

        // Helper to get available teams for a court and column
        function getAvailableTeams(roundIdx, courtIdx, teamCol) {
            // Get all used teams
            const used = new Set(usedTeams);
            // Get already assigned players in this court
            const assignedPlayers = new Set();
            const game = gamesByRound[roundIdx][courtIdx];
            if (game) {
                if (teamCol === "team2" && game.team1) {
                    assignedPlayers.add(game.team1[0]);
                    assignedPlayers.add(game.team1[1]);
                }
                if (teamCol === "team1" && game.team2) {
                    assignedPlayers.add(game.team2[0]);
                    assignedPlayers.add(game.team2[1]);
                }
            }
            // Also, filter out teams with players already assigned in other courts of same round
            const roundGames = gamesByRound[roundIdx];
            roundGames.forEach((g, idx) => {
                if (g && idx !== courtIdx) {
                    if (g.team1) {
                        assignedPlayers.add(g.team1[0]);
                        assignedPlayers.add(g.team1[1]);
                    }
                    if (g.team2) {
                        assignedPlayers.add(g.team2[0]);
                        assignedPlayers.add(g.team2[1]);
                    }
                }
            });
            // Filter teams: not used, and no overlap with assignedPlayers
            return pairSkillsGlobal.filter(p => {
                const teamKey = p.pair.slice().sort().join(',');
                if (used.has(teamKey)) return false;
                if (p.pair.some(player => assignedPlayers.has(player))) return false;
                return true;
            });
        }

        // Render games with select buttons for team1/team2
        function renderGames() {
            let html = '';
            gamesByRound.forEach((roundGames, roundIdx) => {
                html += `<div style="border:2px solid #333; margin:15px 0; padding:10px; border-radius:8px;">
                    <h3>Game ${roundIdx + 1}</h3>
                    <div style="display:flex; gap:30px;">`;
                for (let courtIdx = 0; courtIdx < roundGames.length; courtIdx++) {
                    const game = roundGames[courtIdx];
                    const isSelected = selectedCourt && selectedCourt.roundIdx === roundIdx && selectedCourt.courtIdx === courtIdx;
                    html += `<div style="background:${isSelected ? '#e0ffe0' : 'none'};padding:5px;position:relative;">
                        <b>Court ${courtIdx + 1}:</b><br>`;
                    // Team 1
                    if (game && game.team1) {
                        html += `<span style="color:red">${game.team1[0]} & ${game.team1[1]}</span> (Skill: ${game.skill1})<br>`;
                    } else {
                        html += `<span style="color:gray">[Empty]</span><br>`;
                    }
                    html += `<button class="select-team-btn" data-round="${roundIdx}" data-court="${courtIdx}" data-team="team1" style="margin-bottom:4px;">Select Team 1</button><br>`;
                    // Team 2
                    if (game && game.team2) {
                        html += `<span style="color:red">${game.team2[0]} & ${game.team2[1]}</span> (Skill: ${game.skill2})<br>`;
                    } else {
                        html += `<span style="color:gray">[Empty]</span><br>`;
                    }
                    html += `<button class="select-team-btn" data-round="${roundIdx}" data-court="${courtIdx}" data-team="team2" style="margin-bottom:4px;">Select Team 2</button><br>`;
                    // Delete button
                    html += `<button class="delete-game-btn" data-round="${roundIdx}" data-court="${courtIdx}">Delete</button>`;

                    // Render dropdown inline if this court/team is selected
                    if (isSelected && selectedTeamCol) {
                        const teamCol = selectedTeamCol;
                        const availableTeams = getAvailableTeams(roundIdx, courtIdx, teamCol);
                        if (availableTeams.length === 0) {
                            html += `<div style="color:red; margin-top:8px;">No available teams for this slot.</div>`;
                        } else {
                            let options = availableTeams.map((p, idx) =>
                                `<option value="${idx}">${p.pair[0]} & ${p.pair[1]} (Skill: ${p.skill})</option>`
                            ).join('');
                            html += `
                                <div style="margin-top:8px;">
                                    <label>Select team for ${teamCol === "team1" ? "Team 1" : "Team 2"}:</label>
                                    <select id="teamDropdown">${options}</select>
                                    <button id="setTeamBtn">Set Team</button>
                                </div>
                            `;
                        }
                    }

                    html += `</div>`;
                }
                html += `</div></div>`;
            });
            document.getElementById('games').innerHTML = html;
            // Remove renderTeamDropdown(); as dropdown is now inline
        }

        // Render dropdown for team selection if a team column is selected
        function renderTeamDropdown() {
            const container = document.getElementById('courtSelect');
            container.innerHTML = '';
            if (selectedCourt && selectedTeamCol) {
                const {roundIdx, courtIdx} = selectedCourt;
                const teamCol = selectedTeamCol;
                const availableTeams = getAvailableTeams(roundIdx, courtIdx, teamCol);
                if (availableTeams.length === 0) {
                    container.innerHTML = `<div style="color:red;">No available teams for this slot.</div>`;
                    return;
                }
                let options = availableTeams.map((p, idx) =>
                    `<option value="${idx}">${p.pair[0]} & ${p.pair[1]} (Skill: ${p.skill})</option>`
                ).join('');
                container.innerHTML = `
                    <label>Select team for ${teamCol === "team1" ? "Team 1" : "Team 2"}:</label>
                    <select id="teamDropdown">${options}</select>
                    <button id="setTeamBtn">Set Team</button>
                `;
            }
        }

        document.getElementById('playerForm').onsubmit = function(e) {
            e.preventDefault();
            const numGames = parseInt(document.getElementById('numGames').value, 10);
            const numCourts = parseInt(document.getElementById('numCourts').value, 10);
            const names = [];
            const skills = [];
            for (let i = 0; i < 8; i++) {
                names.push(this['name'+i].value.trim());
                skills.push(parseInt(this['skill'+i].value, 10));
            }
            // Build player objects
            const players = names.map((name, idx) => ({ name, skill: skills[idx] }));

            // Generate all unique doubles
            const pairs = getCombinations(players);
            const pairSkills = pairs.map(pair => ({
                pair: [pair[0].name, pair[1].name],
                skill: pair[0].skill + pair[1].skill
            }));
            pairSkills.sort((a, b) => b.skill - a.skill);

            pairSkillsGlobal = pairSkills;
            usedTeams = new Set();
            selectedCourt = null;
            // Pre-generate games with user-defined courts
            gamesByRound = Array.from({length: numGames}, () => Array(numCourts).fill(null));
            renderGames();
            renderPairs(pairSkills);
            document.getElementById('printGamesBtn').style.display = 'inline-block';
        };

        document.addEventListener('click', function(e) {
            // Select a team slot
            if (e.target && e.target.classList.contains('select-team-btn')) {
                selectedCourt = {
                    roundIdx: parseInt(e.target.getAttribute('data-round')),
                    courtIdx: parseInt(e.target.getAttribute('data-court'))
                };
                selectedTeamCol = e.target.getAttribute('data-team');
                renderGames();
            }

            // Set team from dropdown
            if (e.target && e.target.id === 'setTeamBtn') {
                const {roundIdx, courtIdx} = selectedCourt;
                const teamCol = selectedTeamCol;
                const availableTeams = getAvailableTeams(roundIdx, courtIdx, teamCol);
                const selIdx = document.getElementById('teamDropdown').value;
                const teamData = availableTeams[selIdx];
                if (!teamData) return;
                // Mark team as used
                usedTeams.add(teamData.pair.slice().sort().join(','));
                // Set team in gamesByRound
                if (!gamesByRound[roundIdx][courtIdx]) gamesByRound[roundIdx][courtIdx] = {};
                gamesByRound[roundIdx][courtIdx][teamCol] = teamData.pair;
                gamesByRound[roundIdx][courtIdx][teamCol === "team1" ? "skill1" : "skill2"] = teamData.skill;
                // If both teams are set, clear selection
                if (gamesByRound[roundIdx][courtIdx].team1 && gamesByRound[roundIdx][courtIdx].team2) {
                    selectedCourt = null;
                    selectedTeamCol = null;
                }
                renderGames();
                renderPairs(pairSkillsGlobal); // <-- Add this line to update the left table
            }

            // Handle game deletion
            if (e.target && e.target.classList.contains('delete-game-btn')) {
                const roundIdx = parseInt(e.target.getAttribute('data-round'));
                const courtIdx = parseInt(e.target.getAttribute('data-court'));
                const game = gamesByRound[roundIdx][courtIdx];
                if (game) {
                    if (game.team1) usedTeams.delete(game.team1.slice().sort().join(','));
                    if (game.team2) usedTeams.delete(game.team2.slice().sort().join(','));
                    gamesByRound[roundIdx][courtIdx] = null;
                    selectedCourt = null;
                    selectedTeamCol = null;
                    renderGames();
                }
            }
        });

        document.getElementById('printGamesBtn').onclick = function() {
            let html = `
            <html>
            <head>
                <title>Games Print View</title>
                <style>
                    body { font-family: Arial, sans-serif; margin: 30px; }
                    table { border-collapse: collapse; margin-top: 20px; }
                    th, td { border: 1px solid #ccc; padding: 8px; }
                    th { background: #eee; }
                </style>
            </head>
            <body>
                <h2>Games Schedule</h2>
            `;

            gamesByRound.forEach((roundGames, roundIdx) => {
                html += `<h3>Game ${roundIdx + 1}</h3>
                <table>
                    <tr>
                        <th>Court</th>
                        <th>Team 1</th>
                        <th>Team 2</th>
                    </tr>`;
                roundGames.forEach((game, courtIdx) => {
                    if (game) {
                        html += `<tr>
                            <td>${courtIdx + 1}</td>
                            <td>${game.team1[0]} & ${game.team1[1]}</td>
                            <td>${game.team2[0]} & ${game.team2[1]}</td>
                        </tr>`;
                    } else {
                        html += `<tr>
                            <td>${courtIdx + 1}</td>
                            <td colspan="2" style="color:gray">[Empty]</td>
                        </tr>`;
                    }
                });
                html += `</table>`;
            });

            html += `</body></html>`;
            const printWindow = window.open('', '_blank');
            printWindow.document.write(html);
            printWindow.document.close();
        };

        // Dark theme toggle logic
        const themeToggleBtn = document.getElementById('themeToggleBtn');
        themeToggleBtn.onclick = function() {
            document.body.classList.toggle('dark');
            if (document.body.classList.contains('dark')) {
                themeToggleBtn.textContent = '‚òÄÔ∏è Light Theme';
            } else {
                themeToggleBtn.textContent = 'üåô Dark Theme';
            }
        };

        function renderPairs(pairSkills) {
            let html = '<h3>Doubles Team (Sorted by Skill)</h3>';
            html += '<table><tr><th>Player 1</th><th>Player 2</th><th>Combined Skill</th></tr>';
            pairSkills.forEach((p, idx) => {
                const teamKey = p.pair.slice().sort().join(',');
                const color = usedTeams.has(teamKey) ? 'red' : 'green';
                html += `<tr>
                    <td style="color:${color};font-weight:bold">${p.pair[0]}</td>
                    <td style="color:${color};font-weight:bold">${p.pair[1]}</td>
                    <td>${p.skill}</td>
                </tr>`;
            });
            html += '</table>';
            html += `<div>Total pairs: ${pairSkills.length}</div>`;
            document.getElementById('results').innerHTML = html;
        }
    </script>
</body>
</html>
